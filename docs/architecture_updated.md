# üèóÔ∏è Arquitectura del Sistema ACA 3.0 - Actualizado

## üìã Resumen Ejecutivo

ACA 3.0 es un sistema integral de gesti√≥n contable multi-plataforma que integra:
- **Dashboard Web** con 6 vistas especializadas
- **Integraci√≥n Airtable** para gesti√≥n documental
- **Bots Telegram** para acceso m√≥vil
- **Base Supabase** optimizada con RLS
- **Sincronizaci√≥n Inteligente** con detecci√≥n de duplicados

## üéØ Arquitectura General Actualizada

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Airtable      ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   FastAPI Core   ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   Supabase      ‚îÇ
‚îÇ  (Contador)     ‚îÇ    ‚îÇ  + Dashboard Web ‚îÇ    ‚îÇ (Base de Datos) ‚îÇ
‚îÇ  üìä Docs + Data ‚îÇ    ‚îÇ  üåê 6 Vistas     ‚îÇ    ‚îÇ  üîí RLS + Opt   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  Telegram Bots   ‚îÇ
                    ‚îÇ  ü§ñ Admin + Prod ‚îÇ
                    ‚îÇ  üì± Mobile Ready ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  External APIs   ‚îÇ
                    ‚îÇ  üß† OpenAI       ‚îÇ
                    ‚îÇ  üìÖ Google Cal   ‚îÇ
                    ‚îÇ  üí¨ Slack (Soon) ‚îÇ
                    ‚îÇ  üìù Notion (Soon)‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß Componentes Principales

### 1. **FastAPI Core + Dashboard Web**
- **Ubicaci√≥n**: `/app/main.py` + `/templates/`
- **Puerto**: 8000
- **Tecnolog√≠as**: FastAPI + Jinja2 + Bootstrap 5 + Chart.js

**Endpoints Dashboard**:
```
GET /dashboard           # Vista principal con KPIs
GET /dashboard/empresas  # Gesti√≥n completa empresas  
GET /dashboard/reportes  # Reportes con filtros
GET /dashboard/archivos  # Archivos grid/lista
GET /dashboard/airtable  # Monitor integraci√≥n
GET /dashboard/sync      # Centro sincronizaci√≥n
```

**Endpoints API**:
```
GET  /health            # Estado sistema
GET  /status            # Estado servicios
GET  /docs              # Documentaci√≥n Swagger
POST /sync/airtable     # Sincronizaci√≥n manual
GET  /airtable/statistics # Stats Airtable
```

### 2. **Dashboard Web - 6 Vistas Especializadas**

#### **Vista Principal** (`/dashboard`)
- **KPIs**: Empresas, reportes, archivos, sincronizaciones
- **Estado Servicios**: Supabase, Airtable, Bots en tiempo real
- **Gr√°fico Reportes**: Distribuci√≥n por tipo con Chart.js
- **Actividad Reciente**: √öltimas operaciones del sistema

#### **Gesti√≥n Empresas** (`/dashboard/empresas`)
- **CRUD Completo**: Crear, leer, actualizar empresas
- **B√∫squeda RUT**: Filtrado inteligente por RUT
- **Estados**: Activo/Inactivo con indicadores visuales
- **Navegaci√≥n**: Links directos a reportes por empresa

#### **Gesti√≥n Reportes** (`/dashboard/reportes`)
- **Filtros Avanzados**: A√±o, mes, tipo documento, empresa
- **Origen Datos**: Indicadores Airtable vs manual
- **Vista Archivos**: Acceso directo a documentos adjuntos
- **Estad√≠sticas**: Reportes por per√≠odo y categor√≠a

#### **Gesti√≥n Archivos** (`/dashboard/archivos`)
- **Vista Dual**: Lista detallada y grid visual
- **Tipos Archivo**: PDF, Excel, Word con iconos
- **Previsualizaci√≥n**: Modal con vista previa PDF
- **Filtros**: Por tipo, tama√±o, estado, fecha

#### **Monitor Airtable** (`/dashboard/airtable`)
- **Estado Conexi√≥n**: Real-time status check
- **Estad√≠sticas**: Registros total, pendientes, procesados
- **Gr√°ficos**: Distribuci√≥n por empresa y tipo documento
- **Acciones**: Sincronizaci√≥n manual, test conexi√≥n

#### **Centro Sincronizaci√≥n** (`/dashboard/sync`)
- **Flujo Visual**: 4 pasos con animaci√≥n
- **Logs Tiempo Real**: Consola con colores por tipo
- **Historial**: Timeline de sincronizaciones
- **Configuraci√≥n**: Intervalos autom√°ticos
- **Herramientas**: Verificar duplicados, limpiar cache

### 3. **Integraci√≥n Airtable Avanzada**

**Base Configurada**: "ACA - Gesti√≥n Documental"
**Tabla**: "Reportes_Empresas"

**Campos Obligatorios**:
- `Empresa` (Text): "Nombre Empresa (RUT)" 
- `Fecha subida` (Date): Fecha del documento
- `Tipo documento` (Select): Balance, Estado Resultados, etc.
- `Archivo adjunto` (Attachment): PDFs, Excel
- `Estado subida` (Select): Pendiente, Procesado, Error
- `Comentarios` (Long Text): Notas y tracking

**Servicio Airtable** (`/app/services/airtable_service.py`):
```python
class AirtableService:
    def get_pending_records() -> List[Dict]
    def mark_as_processed(record_id: str) -> bool
    def get_statistics() -> Dict
    def get_all_records() -> List[Dict]
    def test_connection() -> bool
```

### 4. **Sincronizaci√≥n Inteligente**

**Servicio Sync** (`/app/services/sync_service.py`):

**Funciones Clave**:
```python
def sync_from_airtable() -> SyncResult:
    # 1. Obtener registros pendientes de Airtable
    # 2. Para cada registro:
    #    - Extraer RUT del nombre empresa
    #    - Buscar empresa en Supabase por RUT
    #    - Verificar si reporte ya existe (anti-duplicados)
    #    - Insertar o actualizar seg√∫n corresponda
    #    - Sincronizar archivos adjuntos
    #    - Marcar como procesado en Airtable

def _extraer_rut_de_nombre(nombre: str) -> str:
    # Extrae RUT de formato "Empresa (12345678-9)"
    
def _get_empresa_by_rut(rut: str) -> Optional[Dict]:
    # B√∫squeda confiable por RUT en lugar de nombre
    
def _verificar_duplicado(airtable_id: str) -> bool:
    # Verifica si registro ya fue procesado
```

**Flujo de Sincronizaci√≥n**:
1. **Detecci√≥n**: Nuevos registros en Airtable
2. **Extracci√≥n**: RUT desde nombre empresa
3. **B√∫squeda**: Empresa en Supabase por RUT
4. **Verificaci√≥n**: Anti-duplicados por Airtable ID
5. **Procesamiento**: Inserci√≥n de reporte y archivos
6. **Confirmaci√≥n**: Update estado en Airtable

### 5. **Base de Datos Supabase Optimizada**

**Tabla Empresas**:
```sql
CREATE TABLE empresas (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    nombre VARCHAR(255) NOT NULL,
    rut VARCHAR(20) UNIQUE NOT NULL,
    razon_social VARCHAR(255),
    email VARCHAR(255),
    telefono VARCHAR(50),
    direccion TEXT,
    estado VARCHAR(20) DEFAULT 'activo',
    creado_en TIMESTAMPTZ DEFAULT NOW(),
    actualizado_en TIMESTAMPTZ DEFAULT NOW()
);

-- RLS Policy
CREATE POLICY "Usuarios ven solo sus empresas" 
ON empresas FOR ALL 
USING (auth.uid() = user_id);
```

**Tabla Reportes Mensuales**:
```sql
CREATE TABLE reportes_mensuales (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    empresa_id UUID REFERENCES empresas(id) ON DELETE CASCADE,
    titulo VARCHAR(255) NOT NULL,
    descripcion TEXT,
    anio INTEGER NOT NULL,
    mes INTEGER NOT NULL CHECK (mes BETWEEN 1 AND 12),
    tipo_reporte VARCHAR(100) NOT NULL,
    estado VARCHAR(50) DEFAULT 'pendiente',
    comentarios TEXT,
    creado_en TIMESTAMPTZ DEFAULT NOW(),
    actualizado_en TIMESTAMPTZ DEFAULT NOW(),
    
    -- Constraint √∫nico para evitar duplicados
    UNIQUE(empresa_id, anio, mes, tipo_reporte)
);
```

**Tabla Archivos**:
```sql
CREATE TABLE archivos_reportes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    reporte_id UUID REFERENCES reportes_mensuales(id) ON DELETE CASCADE,
    empresa_id UUID REFERENCES empresas(id) ON DELETE CASCADE,
    nombre_archivo VARCHAR(255) NOT NULL,
    tipo_archivo VARCHAR(100),
    tamanio_bytes BIGINT,
    url_archivo TEXT NOT NULL,
    descripcion TEXT,
    activo BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- √çndices para performance
CREATE INDEX idx_archivos_empresa ON archivos_reportes(empresa_id);
CREATE INDEX idx_archivos_reporte ON archivos_reportes(reporte_id);
CREATE INDEX idx_empresas_rut ON empresas(rut);
```

### 6. **Bots Telegram**

#### **Bot Admin** (`/app/bots/handlers/admin_handlers.py`)
- **Comando `/start`**: Men√∫ principal administraci√≥n
- **Comando `/empresas`**: CRUD completo empresas
- **Comando `/stats`**: Estad√≠sticas del sistema
- **Comando `/config`**: Configuraci√≥n servicios
- **Comando `/restart`**: Reinicio de bots

#### **Bot Producci√≥n** (`/app/bots/handlers/production_handlers.py`)
- **Comando `/start`**: Men√∫ usuario final
- **Comando `/reportes`**: Consulta por RUT
- **Comando `/pendientes`**: Tareas pendientes
- **Comando `/asesor`**: Consultas IA
- **Comando `/agendar`**: Sistema citas

### 7. **Sistema de Templates**

**Base Template** (`/templates/base.html`):
- **Sidebar Navegaci√≥n**: 6 vistas + logout
- **Header Responsive**: T√≠tulo din√°mico por p√°gina
- **Footer**: Info sistema y versi√≥n
- **Scripts Comunes**: Bootstrap, Chart.js, Font Awesome

**Template Inheritance**:
```html
<!-- Cada vista extiende base.html -->
{% extends "base.html" %}
{% block title %}Empresas - ACA 3.0{% endblock %}
{% block page_title %}Gesti√≥n de Empresas{% endblock %}
{% block content %}
<!-- Contenido espec√≠fico de la vista -->
{% endblock %}
{% block scripts %}
<!-- JavaScript espec√≠fico de la vista -->
{% endblock %}
```

## üîÑ Flujos de Datos Cr√≠ticos

### **Flujo Carga Documento Contador**

```
1. Contador sube PDF a Airtable
   ‚îú‚îÄ‚îÄ Empresa: "THE WINGDEMO (12345678-9)"
   ‚îú‚îÄ‚îÄ Tipo: "Balance General"
   ‚îú‚îÄ‚îÄ Fecha: "2025-01-08"
   ‚îî‚îÄ‚îÄ Archivo: balance_enero.pdf

2. Sistema detecta nuevo registro
   ‚îú‚îÄ‚îÄ Extrae RUT: "12345678-9"
   ‚îú‚îÄ‚îÄ Busca empresa en Supabase
   ‚îî‚îÄ‚îÄ Encuentra: empresa_id = "uuid-123"

3. Verifica duplicados
   ‚îú‚îÄ‚îÄ Busca comentario con Airtable ID
   ‚îú‚îÄ‚îÄ No encuentra = registro nuevo
   ‚îî‚îÄ‚îÄ Procede con inserci√≥n

4. Inserta reporte_mensual
   ‚îú‚îÄ‚îÄ empresa_id: "uuid-123"
   ‚îú‚îÄ‚îÄ titulo: "Balance General Enero 2025"
   ‚îú‚îÄ‚îÄ anio: 2025, mes: 1
   ‚îú‚îÄ‚îÄ tipo_reporte: "Balance General"
   ‚îî‚îÄ‚îÄ comentarios: "Sincronizado desde Airtable [rec123]"

5. Descarga y almacena archivo
   ‚îú‚îÄ‚îÄ URL temporal de Airtable
   ‚îú‚îÄ‚îÄ Metadatos: nombre, tipo, tama√±o
   ‚îî‚îÄ‚îÄ Inserta en archivos_reportes

6. Actualiza estado Airtable
   ‚îú‚îÄ‚îÄ Estado: "Procesado"
   ‚îî‚îÄ‚îÄ Comentarios: timestamp + detalles

7. Dashboard se actualiza autom√°ticamente
   ‚îú‚îÄ‚îÄ Stats en tiempo real
   ‚îú‚îÄ‚îÄ Nuevo reporte visible
   ‚îî‚îÄ‚îÄ Logs en centro sync
```

### **Flujo Consulta Usuario Telegram**

```
1. Usuario env√≠a: "/reportes 12345678-9"

2. Bot valida formato RUT
   ‚îú‚îÄ‚îÄ Regex validation
   ‚îî‚îÄ‚îÄ Formato correcto ‚úÖ

3. Busca empresa en Supabase
   ‚îú‚îÄ‚îÄ SELECT * FROM empresas WHERE rut = '12345678-9'
   ‚îî‚îÄ‚îÄ Encuentra: "THE WINGDEMO"

4. Obtiene reportes de la empresa
   ‚îú‚îÄ‚îÄ SELECT * FROM reportes_mensuales WHERE empresa_id = 'uuid-123'
   ‚îî‚îÄ‚îÄ Encuentra: 3 reportes

5. Procesa con OpenAI
   ‚îú‚îÄ‚îÄ Contexto: datos empresa + reportes
   ‚îú‚îÄ‚îÄ Prompt: an√°lisis financiero
   ‚îî‚îÄ‚îÄ Respuesta: insights inteligentes

6. Formatea respuesta Telegram
   ‚îú‚îÄ‚îÄ Nombre empresa
   ‚îú‚îÄ‚îÄ Lista reportes con fechas
   ‚îú‚îÄ‚îÄ An√°lisis IA
   ‚îî‚îÄ‚îÄ Botones navegaci√≥n

7. Usuario recibe respuesta completa
   ‚îú‚îÄ‚îÄ Datos estructurados
   ‚îú‚îÄ‚îÄ An√°lisis profesional
   ‚îî‚îÄ‚îÄ Opciones adicionales
```

## üõ°Ô∏è Seguridad y Performance

### **Row Level Security (RLS)**
- **Empresas**: Solo empresas del usuario autenticado
- **Reportes**: Filtrado autom√°tico por empresa_id
- **Archivos**: Acceso granular por reporte

### **Optimizaciones Base Datos**
- **√çndices**: RUT, empresa_id, fechas
- **Constraints**: √önicos para evitar duplicados
- **Triggers**: Actualizaci√≥n autom√°tica timestamps

### **Performance Metrics Actuales**
- **API Response**: <150ms promedio
- **Dashboard Load**: <2s primera carga  
- **Sync 50 registros**: <10s
- **DB Query Time**: <50ms promedio

## üîÆ Roadmap Arquitectural

### **Pr√≥ximas Integraciones**
1. **Notion**: Dashboard ejecutivo CEO
2. **Slack**: Notificaciones equipo
3. **Calendly**: Sistema agendamiento
4. **Deploy**: Render/Vercel producci√≥n

### **Expansi√≥n Multi-Pa√≠s**
- **Multi-DB**: Supabase por regi√≥n
- **Multi-Currency**: Conversiones autom√°ticas  
- **Multi-Language**: i18n completo
- **Compliance**: Regulaciones por pa√≠s

### **Arquitectura Microservicios**
- **Auth Service**: JWT + roles
- **Company Service**: Gesti√≥n empresas
- **Report Service**: Procesamiento reportes
- **File Service**: Almacenamiento archivos
- **Notification Service**: Multi-canal

---

**Esta arquitectura soporta el crecimiento actual y futuro manteniendo simplicidad operacional.**