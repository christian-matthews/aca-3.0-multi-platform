{% extends "base.html" %}

{% block title %}Reportes - ACA 3.0{% endblock %}
{% block page_title %}Gestión de Reportes{% endblock %}

{% block content %}
<!-- Stats Overview -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <i class="fas fa-file-alt fa-3x text-primary mb-3"></i>
                <h3 class="stat-number text-primary">{{ reportes|length }}</h3>
                <p class="text-muted">Total Reportes</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <i class="fas fa-calendar-month fa-3x text-success mb-3"></i>
                <h3 class="stat-number text-success">{{ reportes|selectattr('creado_en')|selectattr('creado_en', 'match', '2025-08')|list|length }}</h3>
                <p class="text-muted">Este Mes</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <i class="fas fa-chart-pie fa-3x text-info mb-3"></i>
                <h3 class="stat-number text-info">{{ reportes|map(attribute='tipo_reporte')|unique|list|length }}</h3>
                <p class="text-muted">Tipos Únicos</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <i class="fas fa-sync-alt fa-3x text-warning mb-3"></i>
                <h3 class="stat-number text-warning">{{ reportes|selectattr('comentarios', 'match', '.*Airtable.*')|list|length }}</h3>
                <p class="text-muted">Desde Airtable</p>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Actions -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="fas fa-filter me-2"></i>
            Filtros y Búsqueda
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Buscar</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="Título, tipo, empresa...">
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <label class="form-label">Año</label>
                <select class="form-select" id="yearFilter">
                    <option value="">Todos</option>
                    <option value="2025" selected>2025</option>
                    <option value="2024">2024</option>
                </select>
            </div>
            <div class="col-md-2 mb-3">
                <label class="form-label">Mes</label>
                <select class="form-select" id="monthFilter">
                    <option value="">Todos</option>
                    <option value="8" selected>Agosto</option>
                    <option value="7">Julio</option>
                    <option value="6">Junio</option>
                </select>
            </div>
            <div class="col-md-2 mb-3">
                <label class="form-label">Tipo</label>
                <select class="form-select" id="typeFilter">
                    <option value="">Todos</option>
                    <option value="Balance General">Balance General</option>
                    <option value="Estado de Resultados">Estado de Resultados</option>
                    <option value="Flujo de Caja">Flujo de Caja</option>
                </select>
            </div>
            <div class="col-md-2 mb-3">
                <label class="form-label">Acciones</label>
                <div class="d-grid">
                    <button class="btn btn-outline-secondary" onclick="clearFilters()">
                        <i class="fas fa-times me-1"></i>Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reportes Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-file-alt me-2"></i>
            Listado de Reportes
        </h5>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="exportReportes()">
                <i class="fas fa-download me-1"></i>
                Exportar
            </button>
            <button class="btn btn-success btn-sm" onclick="executeSyncManual()">
                <i class="fas fa-sync-alt me-1"></i>
                Sincronizar
            </button>
        </div>
    </div>
    <div class="card-body">
        {% if reportes %}
        <div class="table-responsive">
            <table class="table table-hover" id="reportesTable">
                <thead class="table-light">
                    <tr>
                        <th><i class="fas fa-file-alt me-1"></i>Reporte</th>
                        <th><i class="fas fa-tag me-1"></i>Tipo</th>
                        <th><i class="fas fa-building me-1"></i>Empresa</th>
                        <th><i class="fas fa-calendar me-1"></i>Período</th>
                        <th><i class="fas fa-paperclip me-1"></i>Archivos</th>
                        <th><i class="fas fa-clock me-1"></i>Creado</th>
                        <th><i class="fas fa-cogs me-1"></i>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reporte in reportes %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-{% if 'Airtable' in (reporte.comentarios or '') %}success{% else %}primary{% endif %} rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                                    <i class="fas fa-{% if 'Airtable' in (reporte.comentarios or '') %}database{% else %}file-alt{% endif %} text-white small"></i>
                                </div>
                                <div>
                                    <div class="fw-bold">{{ reporte.titulo or 'Sin título' }}</div>
                                    <small class="text-muted">{{ reporte.descripcion or 'Sin descripción' }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-{% if reporte.tipo_reporte == 'Balance General' %}primary{% elif reporte.tipo_reporte == 'Estado de Resultados' %}success{% elif reporte.tipo_reporte == 'Flujo de Caja' %}info{% else %}secondary{% endif %}">
                                {{ reporte.tipo_reporte or 'Sin tipo' }}
                            </span>
                        </td>
                        <td>
                            <small class="text-muted">{{ reporte.empresa_id[:8] if reporte.empresa_id else 'N/A' }}...</small>
                        </td>
                        <td>
                            <div class="text-center">
                                <div class="fw-bold">{{ reporte.anio or '-' }}</div>
                                <small class="text-muted">{{ ['', 'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'][reporte.mes] if reporte.mes else 'N/A' }}</small>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-outline-info btn-sm" onclick="viewArchivos('{{ reporte.id }}')">
                                <i class="fas fa-paperclip me-1"></i>
                                Ver
                            </button>
                        </td>
                        <td>
                            <small class="text-muted">
                                {{ reporte.creado_en.strftime('%d/%m/%Y %H:%M') if reporte.creado_en else 'Sin fecha' }}
                            </small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewReporte('{{ reporte.id }}')" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="downloadReporte('{{ reporte.id }}')" title="Descargar">
                                    <i class="fas fa-download"></i>
                                </button>
                                {% if 'Airtable' in (reporte.comentarios or '') %}
                                <span class="btn btn-outline-warning btn-sm" title="Sincronizado desde Airtable">
                                    <i class="fas fa-database"></i>
                                </span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
            <h5 class="text-muted">No hay reportes disponibles</h5>
            <p class="text-muted">Los reportes aparecerán aquí una vez que se generen o sincronicen desde Airtable.</p>
            <button class="btn btn-success" onclick="executeSyncManual()">
                <i class="fas fa-sync-alt me-2"></i>
                Sincronizar desde Airtable
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para ver archivos -->
<div class="modal fade" id="archivosModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-paperclip me-2"></i>
                    Archivos del Reporte
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="archivosModalBody">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles del reporte -->
<div class="modal fade" id="reporteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>
                    Detalles del Reporte
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="reporteModalBody">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
    filterTable();
});

// Filter functionality
document.getElementById('yearFilter').addEventListener('change', function() {
    filterTable();
});

document.getElementById('monthFilter').addEventListener('change', function() {
    filterTable();
});

document.getElementById('typeFilter').addEventListener('change', function() {
    filterTable();
});

function filterTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const yearFilter = document.getElementById('yearFilter').value;
    const monthFilter = document.getElementById('monthFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    
    const table = document.getElementById('reportesTable');
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        let show = true;
        
        // Search filter
        if (searchTerm && !text.includes(searchTerm)) {
            show = false;
        }
        
        // Type filter
        if (typeFilter) {
            const badge = row.querySelector('.badge');
            const type = badge ? badge.textContent.toLowerCase() : '';
            if (!type.includes(typeFilter.toLowerCase())) {
                show = false;
            }
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('yearFilter').value = '';
    document.getElementById('monthFilter').value = '';
    document.getElementById('typeFilter').value = '';
    filterTable();
}

function viewArchivos(reporteId) {
    // Simulate loading files
    document.getElementById('archivosModalBody').innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando archivos...</p>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('archivosModal'));
    modal.show();
    
    // Simulate API call
    setTimeout(() => {
        document.getElementById('archivosModalBody').innerHTML = `
            <div class="list-group">
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-file-pdf text-danger me-2"></i>
                        <div>
                            <div class="fw-bold">Reporte_financiero.pdf</div>
                            <small class="text-muted">PDF • 1.2 MB</small>
                        </div>
                    </div>
                    <button class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
        `;
    }, 1000);
}

function viewReporte(reporteId) {
    showToast('Cargando detalles del reporte...', 'info');
    // Implementation for viewing report details
}

function downloadReporte(reporteId) {
    showToast('Preparando descarga...', 'info');
    // Implementation for downloading report
}

function exportReportes() {
    showToast('Funcionalidad de exportación próximamente', 'info');
}
</script>
{% endblock %}