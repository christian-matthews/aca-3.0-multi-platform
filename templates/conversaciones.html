{% extends "base.html" %}

{% block title %}Conversaciones - Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">üí¨ Registro de Conversaciones</h1>
            
            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Tipo de Bot</label>
                            <select class="form-select" id="filterBotType">
                                <option value="">Todos</option>
                                <option value="admin">Admin</option>
                                <option value="production">Producci√≥n</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Estado Usuario</label>
                            <select class="form-select" id="filterUserStatus">
                                <option value="">Todos</option>
                                <option value="authorized">Autorizado</option>
                                <option value="unauthorized">No Autorizado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">L√≠mite</label>
                            <select class="form-select" id="filterLimit">
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="200">200</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary mt-4" onclick="loadConversations()">
                                <i class="fas fa-search"></i> Filtrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de Conversaciones -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üìã Conversaciones Recientes</h5>
                    <button class="btn btn-sm btn-success" onclick="loadConversations()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                <div class="card-body">
                    <div id="conversationsLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando conversaciones...</p>
                    </div>
                    
                    <div id="conversationsTable" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Fecha/Hora</th>
                                        <th>Usuario</th>
                                        <th>Chat/User ID</th>
                                        <th>Empresa</th>
                                        <th>Mensaje</th>
                                        <th>Respuesta</th>
                                        <th>Bot</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="conversationsBody">
                                    <!-- Contenido din√°mico -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="conversationsError" style="display: none;" class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Error:</strong> No se pudieron cargar las conversaciones.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles -->
<div class="modal fade" id="conversationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üìÑ Detalles de Conversaci√≥n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="conversationDetails">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadConversations();
    
    // Auto-refresh cada 30 segundos
    setInterval(loadConversations, 30000);
});

async function loadConversations() {
    const loading = document.getElementById('conversationsLoading');
    const table = document.getElementById('conversationsTable');
    const error = document.getElementById('conversationsError');
    
    // Mostrar loading
    loading.style.display = 'block';
    table.style.display = 'none';
    error.style.display = 'none';
    
    try {
        // Obtener filtros
        const botType = document.getElementById('filterBotType').value;
        const userStatus = document.getElementById('filterUserStatus').value;
        const limit = document.getElementById('filterLimit').value;
        
        // Construir URL con par√°metros
        let url = '/api/conversations/recent?limit=' + limit;
        if (botType) url += '&bot_type=' + botType;
        if (userStatus === 'authorized') url += '&authorized_only=true';
        
        const response = await fetch(url);
        const conversations = await response.json();
        
        // Renderizar tabla
        renderConversationsTable(conversations);
        
        // Mostrar tabla
        loading.style.display = 'none';
        table.style.display = 'block';
        
    } catch (err) {
        console.error('Error cargando conversaciones:', err);
        loading.style.display = 'none';
        error.style.display = 'block';
    }
}

function renderConversationsTable(conversations) {
    const tbody = document.getElementById('conversationsBody');
    tbody.innerHTML = '';
    
    if (conversations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No hay conversaciones disponibles</td></tr>';
        return;
    }
    
    conversations.forEach(conv => {
        const row = document.createElement('tr');
        
        // Estado del usuario con badge
        let statusBadge = '';
        if (conv.estado_usuario === 'Autorizado') {
            statusBadge = '<span class="badge bg-success">‚úÖ Autorizado</span>';
        } else {
            statusBadge = '<span class="badge bg-warning">‚ö†Ô∏è No Autorizado</span>';
        }
        
        // Bot tipo con color
        let botBadge = '';
        if (conv.bot_tipo === 'admin') {
            botBadge = '<span class="badge bg-danger">Admin</span>';
        } else {
            botBadge = '<span class="badge bg-primary">Producci√≥n</span>';
        }
        
        row.innerHTML = `
            <td>${new Date(conv.created_at).toLocaleString('es-ES')}</td>
            <td>
                <strong>${conv.usuario_nombre || 'Usuario'}</strong><br>
                <small class="text-muted">@${conv.usuario_username || 'sin_username'}</small>
            </td>
            <td>
                <strong>Chat:</strong> <code>${conv.chat_id}</code><br>
                <strong>User:</strong> <code>${conv.user_id || 'N/A'}</code>
            </td>
            <td>${conv.empresa_nombre}</td>
            <td>
                <div class="text-truncate" style="max-width: 200px;" title="${conv.mensaje}">
                    ${conv.mensaje}
                </div>
            </td>
            <td>
                <div class="text-truncate" style="max-width: 200px;" title="${conv.respuesta || 'Sin respuesta'}">
                    ${conv.respuesta || 'Sin respuesta'}
                </div>
            </td>
            <td>${botBadge}</td>
            <td>${statusBadge}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="showConversationDetails('${conv.id}')">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

async function showConversationDetails(conversationId) {
    try {
        // Aqu√≠ podr√≠as hacer una llamada para obtener m√°s detalles
        // Por ahora, mostrar modal con informaci√≥n b√°sica
        document.getElementById('conversationDetails').innerHTML = `
            <p><strong>ID:</strong> ${conversationId}</p>
            <p>Implementar detalles completos...</p>
        `;
        
        new bootstrap.Modal(document.getElementById('conversationModal')).show();
        
    } catch (err) {
        console.error('Error cargando detalles:', err);
    }
}
</script>
{% endblock %}